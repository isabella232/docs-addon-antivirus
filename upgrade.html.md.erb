---
title: Upgrading Pivotal Anti-Virus
owner: Security Engineering
---

<strong><%= modified_date %></strong>

This topic describes how to upgrade <%= vars.product_full %> (formerly known as ClamAV Add-on for PCF).

##<a id="assume"></a>Compatibility and Prerequisites

See the following topics to ensure you have the required component versions and prerequisites:

* [Product Snapshot](./index.html#snapshot)
* [Prerequisites](./install.html#prereqs)

##<a id="upgrade"></a> Upgrade <%= vars.product_full %>

See the table below for how to upgrade your current version of <%= vars.product_full %>.

<table>
  <col width="22%">
  <col width="78%">
  <tr>
    <th>Upgrade path</th>
    <th>Make sure to...</th>
  </tr>
  <tr>
    <td>v1.x to v2.x</td>
    <td>Uninstall ClamAV Add-on for PCF v1.x and install Pivotal Anti-Virus v2.x.
      For instructions, see <a href="#upgrade-v1-v2">Replace <%= vars.product_old %> v1.x with <%= vars.product_full %> v2.x</a>.</td>
  </tr>
  <tr>
    <td>v2.0 to v2.2</td>
    <td>
      Do the following:
      <ul>
        <li>(Optional) Decide whether to use <%= vars.product_short_mirror %> or an existing mirror.</li>
        <li>Configure the mirror port.</li>
        <li>Reset the value of <strong>CPU limit (Percentage)</strong>.</li>
        <li>Set <strong>Timeout to connect to the database server (in seconds)</strong>.</li>
      </ul>
      For instructions, see <a href="#upgrade-v20-v21">Upgrade <%= vars.product_full %> v2.0.x to v2.1.x or Later</a>
    </td>
  </tr>
  <tr>
    <td>v2.1 to v2.2</td>
    <td>
      Do the following:
      <ul>
        <li>Reset the value of <strong>CPU limit (Percentage)</strong>.</li>
        <li>Set <strong>Timeout to connect to the database server (in seconds)</strong>.</li>
      </ul>
      For instructions, see <a href="#upgrade-v21-v22">Upgrade <%= vars.product_full %> v2.1.x to v2.2.x or Later</a>
    </td>
  </tr>
</table>

##<a id="upgrade-v1-v2"></a>Replace <%= vars.product_old %> v1.x with <%= vars.product_full %> v2.x

To uninstall <%= vars.product_old %> v1.x and install <%= vars.product_full %> v2.x in its place:

1. Retrieve the latest runtime config YML by running the following command:

    ```
    bosh -e ENVIRONMENT runtime-config > PATH-TO-SAVE-THE-RUNTIME-CONFIG
    ```

    Where:
    * `ENVIRONMENT` is your environment
    * `PATH-TO-SAVE-THE-RUNTIME-CONFIG` is the location where you want to save the runtime configuration.

    For example:
    <pre class="terminal">
      $ bosh -e my-env runtime-config > /runtime/config/
    </pre>

1. In the runtime config YML, remove all ClamAV properties under the `releases:` and `addons:` sections.

1. Update the runtime config:

    ```
    bosh -e ENVIRONMENT update-runtime-config --name=clamav PATH-TO-SAVE-THE-RUNTIME-CONFIG
    ```

    Where:
    * `ENVIRONMENT` is your environment
    * `PATH-TO-SAVE-THE-RUNTIME-CONFIG` is the location of the runtime configuration you are updating.

    For example:
    <pre class="terminal">
      $ bosh -e my-env update-runtime-config --name=clamav /runtime/config/
    </pre>

1. Follow the instructions in
[Installing and Configuring <%= vars.product_full %>](./install.html)
to set up the <%= vars.product_full %> tile.

##<a id="upgrade-v20-v21"></a> Upgrade <%= vars.product_full %> v2.0.x to v2.1.x or Later

Additional configurations might be required when upgrading from v2.0.x.
This is because of the following features introduced in <%= vars.product_short %> v2.1:

  * Support for existing mirrors with TLS
  * Ability to configure the **Mirror Port** used by <%= vars.product_short %>

###<a id="use-existing"></a> (Optional) Using an Existing Mirror

In v2.0.x, <%= vars.product_short %> only supported using mutual TLS (mTLS) with <%= vars.product_short_mirror %>.
However, in v2.1.x and later, <%= vars.product_short %> permits the use of an existing mirror with TLS.

If you are currently using <%= vars.product_short_mirror %>
and want to use an existing mirror instead,
Pivotal recommends that you configure <%= vars.product_short %> to use the new mirror before
uninstalling <%= vars.product_short_mirror %>.

###<a id="configure-mirror"></a>Configuring the Mirror Port

In v2.0.x, the port used by <%= vars.product_short %> and
<%= vars.product_short_mirror %> was `80` and was not configurable.
In v2.1.x and later, the default port used is `6501` and is now configurable.

**If you are using the <%= vars.product_short_mirror %> with <%= vars.product_short %>,**
do one of the following:

  * If you want to use the default port with <%= vars.product_short %> and
  <%= vars.product_short_mirror %>, then you do not need to make any changes after upgrading.

  * If you want to change the ports used by <%= vars.product_short %> and
  <%= vars.product_short_mirror %>, see [Upgrade Procedure](#upgrade-procedure-v20-v21) below.

**If you are using an existing mirror with <%= vars.product_short %>,**
do one of the following:

  * Configure your existing mirror to use the default `6501` port
  used by <%= vars.product_short %>.
  * Configure <%= vars.product_short %> to use the port used by your existing mirror.
    To do this, see [Upgrade Procedure](#upgrade-procedure-v20-v21) below.


###<a id="upgrade-procedure-v20-v21"></a> Upgrade Procedure

To upgrade <%= vars.product_full %>:

1. If you are upgrading to v2.2 or later, record the value in the <strong>CPU limit (percentage)</strong> field.

    <p class="note"><strong>Note:</strong>
      Upgrading to v2.2 or later restores this field to the default value of 50%.
      All other configuration details are kept when upgrading.
    </p>
1. Download the latest version of <%= vars.product_short %>
   from [Pivotal Network](https://network.pivotal.io/products/p-clamav-addon) to your local machine.
1. Upload the new `.pivotal` files to <%= vars.ops_manager %>.

1. If required, upload any stemcells associated with the update.

1. If you are upgrading to v2.2 or later:
  1. Reset the value in the <strong>CPU limit (percentage)</strong> field. For instructions, see [Configure Anti-Virus](./install.html#configure).
  1. Set the **Timeout to connect to the database server (in seconds)** field. For instructions, see [Configure Anti-Virus](./install.html#configure).

1. (Optional) If you are currently using <%= vars.product_short_mirror %>  and want to switch
  to an existing mirror instead, configure <%= vars.product_short %> to use an existing mirror.
  This can be with or without TLS.
  For instructions, see [Configure Anti-Virus](./install.html#configure).

1. (Optional) If you are using <%= vars.product_short_mirror %>  and want to change
the ports used by Anti-Virus and Anti-Virus Mirror, follow the procedure in
[Changing the Port Used by <%= vars.product_short %> and <%= vars.product_short_mirror %>](./changing-ports.html).

1. If you are using an existing mirror, check that the port used by <%= vars.product_short %>
and your mirror are the same.
If they are not, configure the **Mirror Port** used for <%= vars.product_short %>:
  * **If you want to change the Mirror Port in <%= vars.product_short %> to use the port that your mirror uses,** follow the procedure in
        [Change the Port in the <%= vars.product_short %> Tile](./changing-ports-existing.html#change-antivirus).
  * **If you want to change the port to use the <%= vars.product_short %> default of `6501`,** do that now.

1. If you did not do the procedures in step 7 or 8, apply configuration changes for your whole foundation:
  1. Return to the <%= vars.ops_manager %> Installation Dashboard and click **Review Pending Changes**.
  3. Select all the products in your foundation and click **Apply Changes**.

1. If you configured an existing mirror in step 5 of this procedure, uninstall
<%= vars.product_short_mirror %> and change the **Mirror Port** in the
<%= vars.product_short %> tile by following the instructions in
[Changing the Port Used by <%= vars.product_short %> with an Existing Mirror](./changing-ports-existing.html).


##<a id="upgrade-v21-v22"></a>Upgrade <%= vars.product_full %> 2.1.x to 2.2.x and Later

To upgrade <%= vars.product_full %>:

1. If you are upgrading to v2.2 or later, record the value in the <strong>CPU limit (percentage)</strong> field.

    <p class="note"><strong>Note:</strong>
      Upgrading to v2.2 or later restores this field to the default value of 50%.
      All other configuration details are kept when upgrading.
    </p>
1. Download the latest version of <%= vars.product_short %>
   from [Pivotal Network](https://network.pivotal.io/products/p-clamav-addon) to your local machine.

1. If you do not have an existing mirror, download the latest version <%= vars.product_short_mirror %>
  from [Pivotal Network](https://network.pivotal.io/products/p-clamav-addon) to your local machine.

1. Upload the new `.pivotal` files to <%= vars.ops_manager %>.

1. If required, upload any stemcells associated with the update.

1. Reset the value in the <strong>CPU limit (percentage)</strong> field. For instructions, see [Configure Anti-Virus](./install.html#configure).

1. Set the **Timeout to connect to the database server (in seconds)** field. For instructions, see [Configure Anti-Virus](./install.html#configure).

1. Return to the <%= vars.ops_manager %> Installation Dashboard and click **Review Pending Changes**.

3. Ensure all products are selected and click **Apply Changes**.
